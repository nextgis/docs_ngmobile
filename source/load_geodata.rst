.. sectionauthor:: Дмитрий Барышников <dmitry.baryshnikov@nextgis.ru>

.. _ngmobile_load_geodata:

Загрузка данных
===============

В программе имеется возможность загрузки локальных данных с облачных хранилищ или 
с хранилища мобильного устройства.
Существуют следующие типы хранения локальных данных: GeoJSON, тайловый кэш, 
настраиваемые формы.

GeoJSON
-------

Для того, чтобы загрузить в программу файл формата GeoJSON необходимо выполнить 
следующую последовательность шагов:

1. Вызвать меню опций и выбрать пункт "Добавить слой", далее выбрать пункт меню    "Локальный" (см. :numref:`ngmobile_add_ngw_layer_geo_pic`) 

.. figure:: _static/add_layer1.png
   :name: ngmobile_add_ngw_layer_geo_pic
   :align: center
   :height: 10cm
    
   Добавление локального слоя

2. В открывшемся окне выбора сохраненных файлов на диске мобильного устройства 
   выбрать необходимый для загрузки файл формата GeoJSON    (см. :numref:`ngmobile_saved_files_on_the_drive_unit_pic`): 

.. figure:: _static/saved_files_on_the_drive_unit.png
   :name: ngmobile_saved_files_on_the_drive_unit_pic
   :align: center
   :height: 10cm
   
   Окно с сохраненными файлами на диске мобильного устройства


3. После выбора файла откроется диалог настройки параметров создаваемого слоя, в 
   котором можно задать имя слоя (см. :numref:`ngmobile_layer_settings_geo_pic`): 

.. figure:: _static/layer_settings_geo.png
   :name: ngmobile_layer_settings_geo_pic
   :align: center
   :height: 10cm

   Настройки параметров создаваемого слоя

   
4. При нажатии на кнопку "Создать", начнется 
   процесс обработки и создания слоя (см. :numref:`ngmobile_processing_and_creation_layer_pic`): 

.. figure:: _static/processing_and_creation_layer.png
   :name: ngmobile_processing_and_creation_layer_pic
   :align: center
   :height: 10cm  

   Окно обработки и создания слоя

.. note::
   В случае загрузки в программу файла формата GeoJSON создаваемый слой в результате 
   загрузки геоданных такого типа будет всегда векторным!

Наличие или отсутствие слоя можно проверить в дереве слоев. В случае удачной процедуры 
обработки и создания слоя, новый слой располагается первым в дереве слоев (см. :numref:`ngmobile_tree_layers_geo_pic`): 

.. figure:: _static/tree_layers_geo.png
   :name: ngmobile_tree_layers_geo_pic
   :align: center
   :height: 10cm  

   Дерево слоев

*Требования к формату GeoJSON:*

* :term:`Система координат` геометрий может быть WGS 84 (EPSG:4326) или Web Mercator (EPSG:3857). Если на вход будет подан файл   в другой системе координат, то будет выведено сообщение о том, что такая система координат не поддерживается. 
* Геометрия в файле должна быть одного типа. Если во входном файле содержаться геометрии 
  разного типа, то будут загружены записи, у которых тип геометрии совпадает с первой 
  записью (геометрия первой записи файла определяет тип геометрии слоя).
* Текстовые строки должны быть кодированы в формате UTF-8. 

.. note::
   Подробнее о формате GeoJSON можно прочитать в его `спецификации <http://geojson.org/>`_. 
   GeoJSON основывается на формате JSON (см. `RFC 4627 <https://www.ietf.org/rfc/rfc4627.txt>`_).

Особенностью редактирования векторного слоя, полученного при загрузке файла формата GeoJSON, является заполнение стандартной 
формы редактирования атрибутов. Такая стандартная форма содержит следующие поля:

1. Текстовое поле для ввода текста и цифр.
2. Диалог ввода и времени.
3. Кнопка добавления фотографии и записи.

Пример стандартной формы редактирования атрибутов слоя представлен на :numref:`ngmobile_standard_form_layer_attributes_pic`: 

.. figure:: _static/standard_form_layer_attributes.png
   :name: ngmobile_standard_form_layer_attributes_pic
   :align: center
   :height: 10cm  
    
   Стандартная форма редактирования атрибутов слоя

Подробнее о редактировании файла формата GeoJSON описано разделе :ref:`ngmobile_editing`.


Тайловый кэш
------------

Тайловый кэш представляет собой архив формата zip, в котором упакованы папки и тайлы 
в соответствии с нарезкой (например, folder_z/folder_x/y.png). Сами папки уровня Z 
могут находится в корне архива или в одной папке в корне архива (название папки 
может быть любым, но папка должна быть одна). Более глубокая вложенность не допускается. 

Тайловый кэш может быть получен при помощи модуля расширения NextGIS QGIS - QTiles. 
Полученный в результате работы модуля архив можно загрузить на устройство в любую 
доступную папку.

Для того, чтобы загрузить в программу архив формата zip, в котором упакованы папки 
и тайлы необходимо выполнить следующую последовательность шагов:

1. Вызвать меню опций и выбрать пункт "Добавить слой", далее выбрать пункт меню "Локальный" 
   (см. :numref:`ngmobile_add_ngw_layer_geo_pic`) 

2. В открывшемся окне выбора сохраненных файлов на диске мобильного устройства 
   выбрать необходимый для загрузки архив формата ziр (см. :numref:`ngmobile_files_on_the_drive_unit_tms_pic`): 

.. figure:: _static/files_on_the_drive_unit_tms.png
   :name: ngmobile_files_on_the_drive_unit_tms_pic
   :align: center
   :height: 10cm
   
   Окно с файлами на диске мобильного устройства 

3. После выбора  на диске устройства архива формата zip откроется диалог настройки 
параметров создаваемого слоя, в котором можно выбрать тип тайлового слоя (систему 
кодирования тайлов) - XYZ (OSM) или TMS (OSGeo) (см. :numref:`ngmobile_layer_setting_tms_pic`): 

.. figure:: _static/layer_setting_tms.png
   :name: ngmobile_layer_setting_tms_pic
   :align: center
   :height: 10cm

   Настройка параметров тайлового слоя

4. При нажатии на кнопку "Создать", 
начнется процесс обработки и создания слоя (см. :numref:`ngmobile_processing_and_creation_layer_tms_pic`): 

.. figure:: _static/processing_and_creation_layer_tms.png
   :name: ngmobile_processing_and_creation_layer_tms_pic
   :align: center
   :height: 10cm  

   Окно обработки и создания слоя

Наличие или отсутствие тайлового слоя можно проверить в дереве слоев. В случае 
удачной процедуры обработки и создания слоя,  имя нового слоя будет отображаться 
первым в дереве слоев (см. :numref:`ngmobile_tree_layers_tms_pic`): 

.. figure:: _static/tree_layers_tms.png
   :name: ngmobile_tree_layers_tms_pic
   :align: center
   :height: 10cm  

   Меню дерева слоев


Настраиваемые формы
-------------------

.. versionadded:: 2.2

Файл формата ngfb получается в результате работы программы NextGIS FormBuilder и представляет собой файл :term:`GeoJSON` 
и файлы с дополнительной информацией (JSON), которые упакованы в архив zip, но расширением ngfb.

Для того, чтобы загрузить в программу файл формата ngfb, необходимо выполнить 
следующую последовательность шагов:

1. Вызвать меню опций и выбрать пункт "Добавить слой", далее выбрать пункт меню "Локальный" (см. :numref:`ngmobile_add_ngw_layer_geo_pic`) 

2. В открывшемся окне выбора сохраненных файлов на диске мобильного устройства 
   выбрать необходимый для загрузки файл формата ngfb (см. :numref:`ngmobile_files_on_the_drive_unit_tms_pic`)

3. После выбора файла откроется диалог настройки параметров создаваемого слоя, в 
   котором можно задать имя слоя (см. :numref:`ngmobile_settind_layer_form_pic`): 

.. figure:: _static/settind_layer_form.png
   :name: ngmobile_settind_layer_form_pic
   :align: center
   :height: 10cm

   Настройки параметров создаваемого слоя

   
4. При нажатии на кнопку "Создать", начнется процесс обработки и создания слоя (см. :numref:`ngmobile_loading_layer_form_pic`): 

.. figure:: _static/loading_layer_form.png
   :name: ngmobile_loading_layer_form_pic
   :align: center
   :height: 10cm  

   Окно создания слоя

Особенностью редактирования слоя на базе файла формата ngfb является заполнение пользовательской 
формы редактирования атрибутов. Такая пользовательская форма содержит разные поля, 
доступные для заполнения или выбора из выпадающего списка.


Пример пользовательской формы редактирования атрибутов слоя представлен на :numref:`ngmobile_non-standard_form_pic`: 

.. figure:: _static/non-standard_form.png
   :name: ngmobile_non-standard_form_pic
   :align: center
   :height: 10cm  
    
   Пользовательская форма редактирования атрибутов слоя

Подробнее о редактировании файла формата ngfb изложено в разделе :ref:`ngmobile_editing`.

Подключение тайлового сервиса
-----------------------------
 
При выборе пункта меню "веб" (см. :numref:`ngmobile_main_activity_pic` п. 3) открывается диалог, представленный на :numref:`ngmobile_add_tms_pic`.

.. figure:: _static/ngmobile_addtms.png
   :name: ngmobile_add_tms_pic
   :align: center
   :height: 11cm
   
   Диалог подключения тайлового источника геоданных.
   
   Цифрами обозначено: 1 - название нового слоя; 2 - адрес тайлов слоя; 3 - тип тайлового сервиса; 4 - логин; 5 - пароль; 6 - кнопка создания слоя; 7 - кнопка отмены.
   
При формировании адреса сервиса тайлов необходимо указать место в адресе значений X (номер тайла по горизонтали), Y (номер тайла по вертикали) и Z (уровень зума). Для этого в строке адреса на месте цифры соответствующей Х необходимо поставить подстановочный код **{x}**, для Y - **{y}**, для Z - **{z}**. Дополнительно в строке адреса можно указать поддомены (например, для поддоменов a.tileopenstreetmap.org, b.tileopenstreetmap.org, c.tileopenstreetmap.org адрес будет выглядеть так: **{a,b,c}.tile.openstreetmap.org**).

.. note::

   При загрузке тайлов на каждый адрес (поддомен) приложение осуществляет запрос 
   в два потока. Таким образом для адреса {a,b,c}.tile.openstreetmap.org приложение 
   будет скачивать тайлы в 6 потоков.
   
Все полученные из сети Интернет/Интранет тайлы кэшируются на карте памяти. При 
запросе конкретного тайла, в начале проверяется локальный кэш. Если в локальном 
кэше есть тайл и его время создания менее семи дней, то на карту будет выведен он. 
Также кэшированный тайл будет выведен при отсутствии подключения к сети Интернет/Интранет 
или если в ходе загрузи был сбой. Полученный из сети Интернет/Интранет тайл перекрывает 
имеющийся в кэше.

В списке выбора типа тайлового слоя (см. :numref:`ngmobile_add_tms_pic`, п. 3) имеется следующий выбор:

* XYZ (OSM) - стандартный тип тайлового сервиса;
* TMS (OSGeo) - в соответствии со стандартом OSGeo.

Если для доступа к тайлам необходима аутентификация, то можно указать логин и пароль.

.. note::

   Поддерживается только `Basic access authentication <http://en.wikipedia.org/wiki/Basic_access_authentication>`_. 

Кэширование данных тайлового сервиса
------------------------------------

.. versionadded:: 2.2

Для создания изображения используются :term:`тайлы <тайл>`, полученные из сети Интернет, 
которые кэшируются на карте памяти устройства. Кэшированный тайл будет доступен 
при отсутствии подключения к сети Интернет. 
Для загрузки тайлов на текущий охват карты следует выбрать пункт меню "Загрузить тайлы", после 
выбора которого откроется окно с настройками загрузки тайлов (см. :numref:`ngmobile_levels_of_zoom_pic`):

.. figure:: _static/levels_of_zoom.png
   :name: ngmobile_levels_of_zoom_pic
   :align: center
   :height: 10cm
 
   Окно выбора уровня зума для загрузки тайлов

Следует обратить внимание, что чем меньше уровень выбранного зума для загрузки тайлов, 
тем меньшее количество тайлов попадают в интересующую нас область и тем быстрее 
происходит загрузка всего изображения.

.. note::
   Если список загружаемых тайлов для заданного диапазона зумов превышает 1000, 
   то будет загружена только первая 1000 тайлов. Остальные тайлы не будут загружаться 
   из-за ограничений на переполнение памяти.

После установки на шкале масштабов необходимого диапазона зума загрузки тайлов можно начинать 
загрузку тайлов. В открывшемся окне выбраем пункт меню "Начать".
Процесс загрузки тайлов переносится в панель статуса, где за ним можно наблюдать.
Если необходимо завершить загрузку тайлов,то в области панели загрузки тайлов следует 
сделать следующее.
Коснитесь экрана большим и указательным пальцами и разведите 
их в стороны, скользя пальцами по экрану. 
В результате таких действий появится кнопка "Стоп", при нажатии на которую процесс 
загрузки тайлов завершится (см. :numref:`ngmobile_loading_tiles_in_the_status_bar_pic`):


.. figure:: _static/loading_tiles_in_the_status_bar.png
   :name: ngmobile_loading_tiles_in_the_status_bar_pic
   :align: center
   :height: 10cm

   Индикация процесса загрузки тайлов в панели статуса

